<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>文章阅读</title>
    <style>
      :root { --bg:#f6f1e8; --card:#fffdfa; --ink:#1f2a37; --muted:#586677; --line:#dccfb8; }
      * { box-sizing:border-box; }
      body { margin:0; font-family:"Avenir Next","Manrope","IBM Plex Sans","PingFang SC",sans-serif; color:var(--ink); background:var(--bg); }
      .page { max-width: 1060px; margin:0 auto; padding: 20px 16px 40px; }
      .card { border:1px solid var(--line); border-radius:14px; background:var(--card); padding:14px; }
      h1 { margin:0; font-size:26px; }
      .en-title { margin-top:6px; font-size:15px; color:#3f4d5a; }
      .meta { margin-top:8px; font-size:12px; color:var(--muted); }
      .toolbar { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
      .btn { border:1px solid var(--line); background:#fff3e7; border-radius:9px; padding:8px 12px; cursor:pointer; font-size:13px; }
      .btn.active { background:#f2d8c6; border-color:#c98c6f; }
      .tags { margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }
      .pill { border:1px solid var(--line); background:#f8f2e8; border-radius:999px; padding:2px 8px; font-size:12px; }
      .summary { margin-top:14px; font-size:15px; line-height:1.75; }
      .grid { margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      .pane { border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; }
      .pane h3 { margin:0 0 8px; font-size:14px; color:var(--muted); }
      .text { white-space: pre-wrap; line-height:1.8; font-size:15px; }
      .empty { color:var(--muted); padding:12px; }
      @media (max-width: 920px) { .grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="card">
        <h1 id="zhTitle">加载中...</h1>
        <div class="en-title" id="enTitle"></div>
        <div class="meta" id="meta"></div>
        <div class="toolbar">
          <button id="modeZh" class="btn active" type="button">中文阅读</button>
          <button id="modeBi" class="btn" type="button">中英文对照</button>
          <a id="sourceLink" class="btn" target="_blank" rel="noopener noreferrer">打开原文</a>
        </div>
        <div class="tags" id="tags"></div>
        <div class="summary" id="summary"></div>
        <div id="contentArea"></div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const postId = params.get('id');
      let post = null;
      let mode = 'zh';

      const zhTitleEl = document.getElementById('zhTitle');
      const enTitleEl = document.getElementById('enTitle');
      const metaEl = document.getElementById('meta');
      const tagsEl = document.getElementById('tags');
      const summaryEl = document.getElementById('summary');
      const contentAreaEl = document.getElementById('contentArea');
      const sourceLinkEl = document.getElementById('sourceLink');
      const modeZhEl = document.getElementById('modeZh');
      const modeBiEl = document.getElementById('modeBi');

      function esc(s) {
        return (s || '').replace(/[&<>"]/g, (c) => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[c]));
      }

      function render() {
        if (!post) return;
        zhTitleEl.textContent = `中文标题：${post.zh_title || post.title || ''}`;
        enTitleEl.textContent = `English Title: ${post.title || ''}`;
        metaEl.textContent = `${post.blog_id || ''} · ${(post.published_at || '').replace('T',' ').slice(0,16)}`;
        summaryEl.textContent = post.zh_summary || '';
        sourceLinkEl.href = post.url || '#';

        const tags = [];
        (post.topics || []).slice(0,8).forEach((x) => tags.push(`Topic: ${x}`));
        (post.labels || []).slice(0,8).forEach((x) => tags.push(`Tag: ${x}`));
        tagsEl.innerHTML = tags.map((x) => `<span class="pill">${esc(x)}</span>`).join('');

        modeZhEl.classList.toggle('active', mode === 'zh');
        modeBiEl.classList.toggle('active', mode === 'bilingual');

        if (mode === 'zh') {
          contentAreaEl.innerHTML = `<div class="pane"><h3>中文正文</h3><div class="text">${esc(post.content_zh || post.zh_summary || '')}</div></div>`;
        } else {
          contentAreaEl.innerHTML = `
            <div class="grid">
              <div class="pane"><h3>English</h3><div class="text">${esc(post.content_en || '')}</div></div>
              <div class="pane"><h3>中文</h3><div class="text">${esc(post.content_zh || '')}</div></div>
            </div>
          `;
        }
      }

      async function load() {
        if (!postId) {
          contentAreaEl.innerHTML = '<div class="empty">缺少文章 id 参数</div>';
          return;
        }
        const r = await fetch(`/api/post/${encodeURIComponent(postId)}`);
        const data = await r.json();
        if (!data.ok) {
          contentAreaEl.innerHTML = `<div class="empty">加载失败：${esc(data.error || 'unknown')}</div>`;
          return;
        }
        post = data.post;
        render();
      }

      modeZhEl.addEventListener('click', () => { mode = 'zh'; render(); });
      modeBiEl.addEventListener('click', () => { mode = 'bilingual'; render(); });
      load();
    </script>
  </body>
</html>
