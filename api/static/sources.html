<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数据源管理</title>
    <style>
      :root {
        --bg: #f5f1e8;
        --card: #fffdfa;
        --ink: #1f2a37;
        --muted: #51606f;
        --line: #dccfb8;
        --accent: #b5522e;
      }
      * { box-sizing: border-box; touch-action: manipulation; }
      html { scroll-behavior: smooth; }
      body {
        margin: 0;
        font-family: "Avenir Next", "Manrope", "IBM Plex Sans", "PingFang SC", sans-serif;
        color: var(--ink);
        background: var(--bg);
      }

      @media (prefers-color-scheme: dark) {
        :root { --bg:#1a1a1a; --card:#242424; --ink:#e8e0d4; --muted:#9aa3ad; --line:#3a3530; --accent:#d4704a; }
        .btn { background:#2e1e14; }
        .btn:hover { background:#3d2518; }
        .btn-danger { background:#2e1210; border-color:#7a3020; }
        .row input { background:#2a2a2a; color:var(--ink); }
        th { background:#1e1e1e; }
      }

      .page { max-width: 1220px; margin: 0 auto; padding: 22px 16px 40px; }
      .card { border: 1px solid var(--line); border-radius: 14px; background: var(--card); padding: 14px; }
      h1 { margin: 0; font-size: 28px; }
      .sub { margin-top: 6px; color: var(--muted); font-size: 13px; }
      .toolbar { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .btn {
        border: 1px solid var(--line);
        background: #fff2e6;
        border-radius: 9px;
        padding: 8px 12px;
        font-size: 13px;
        cursor: pointer;
        min-height: 44px;
      }
      .btn:hover { background: #ffe7d1; }
      .btn:active { opacity: 0.8; transform: scale(0.97); }
      @media (hover: none) { .btn:hover { background: #fff2e6; } }
      .btn-danger { background: #fff0eb; border-color: #d6ada1; }
      .row { margin-top: 12px; display: grid; grid-template-columns: 1.4fr 1fr 1fr auto; gap: 8px; }
      .row input {
        border: 1px solid var(--line);
        border-radius: 9px;
        padding: 9px 10px;
        font-size: 13px;
        min-height: 44px;
      }
      .msg { margin-top: 8px; color: var(--muted); font-size: 13px; min-height: 20px; }
      .table-wrap { margin-top: 14px; overflow: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th, td { border-bottom: 1px solid var(--line); padding: 8px 6px; text-align: left; vertical-align: top; }
      .ok { color: #1d6d3f; }
      .err { color: #ab3b1f; }

      @media (max-width: 980px) {
        .row { grid-template-columns: 1fr; }
      }

      /* ── 手机端：表格变卡片 (≤767px) ── */
      @media (max-width: 767px) {
        .page { padding: 14px 10px 28px; }
        h1 { font-size: 22px; }

        .table-wrap { overflow: visible; }
        table, tbody, tr { display: block; }
        thead { display: none; }
        tr {
          border: 1px solid var(--line);
          border-radius: 12px;
          padding: 12px;
          margin-bottom: 10px;
          background: var(--card);
        }
        td {
          display: block;
          border: none;
          padding: 3px 0;
          font-size: 13px;
          word-break: break-all;
        }
        td::before {
          font-weight: 700;
          color: var(--muted);
          font-size: 11px;
          display: block;
          margin-bottom: 2px;
        }
        td:nth-child(1)::before { content: "来源"; }
        td:nth-child(2)::before { content: "博客地址"; }
        td:nth-child(3)::before { content: "主题"; }
        td:nth-child(4)::before { content: "近期更新"; }
        td:nth-child(5)::before { content: "网络状态"; }
        td:nth-child(6) {
          margin-top: 10px;
          display: flex;
          gap: 8px;
        }
        td:nth-child(6)::before { display: none; }
        td:nth-child(6) .btn { flex: 1; justify-content: center; display: flex; align-items: center; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="card">
        <h1>数据源管理</h1>
        <div class="sub">支持：列表查看、手工添加、删除、预填 Gist 清单</div>

        <div class="toolbar">
          <label>
            统计窗口
            <select id="days" class="btn">
              <option value="7" selected>近7天</option>
              <option value="14">近14天</option>
              <option value="30">近30天</option>
            </select>
          </label>
          <button id="prefillBtn" class="btn" type="button">预填之前的 Gist 数据</button>
          <button id="importGistBtn" class="btn" type="button">从在线 Gist 导入</button>
        </div>

        <form id="addForm" class="row">
          <input id="feedUrl" type="url" placeholder="RSS 地址 (https://...)" required />
          <input id="title" type="text" placeholder="博客名称(可选)" />
          <input id="siteUrl" type="url" placeholder="博客地址(可选)" />
          <button class="btn" type="submit">添加数据源</button>
        </form>

        <div class="msg" id="msg"></div>

        <div class="table-wrap" id="tableWrap"></div>
      </div>
    </div>

    <script>
      const state = { sources: [] };
      const msgEl = document.getElementById('msg');
      const tableWrapEl = document.getElementById('tableWrap');
      const daysEl = document.getElementById('days');

      function esc(s) {
        return (s || '').replace(/[&<>"]/g, (c) => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[c]));
      }

      function renderTable() {
        if (!state.sources.length) {
          tableWrapEl.innerHTML = '<div class="msg">暂无数据源</div>';
          return;
        }
        const rows = state.sources.map((s) => {
          const cls = s.network_status === 'OK' ? 'ok' : (s.network_status === 'ERROR' ? 'err' : '');
          return `
            <tr>
              <td>${esc(s.name)}</td>
              <td><a href="${esc(s.blog_address || s.feed_url)}" target="_blank" rel="noopener noreferrer">${esc(s.blog_address || s.feed_url)}</a></td>
              <td>${esc(s.topic || 'General Tech')}</td>
              <td>${s.weekly_updates || 0}</td>
              <td class="${cls}">${esc(s.network_status || 'UNKNOWN')}</td>
              <td>
                <button class="btn js-refresh" data-id="${s.id}">刷新访问</button>
                <button class="btn btn-danger js-del" data-id="${s.id}">删除</button>
              </td>
            </tr>
          `;
        }).join('');

        tableWrapEl.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>数据源</th>
                <th>博客地址</th>
                <th>主题</th>
                <th>近${esc(daysEl.value)}天更新</th>
                <th>网络状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;

        tableWrapEl.querySelectorAll('.js-del').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (!id || !confirm('确认删除该数据源？')) return;
            await fetch(`/api/sources/${id}?purge_posts=true`, { method: 'DELETE' });
            await loadSources();
          });
        });
        tableWrapEl.querySelectorAll('.js-refresh').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (!id) return;
            msgEl.textContent = `正在刷新数据源 #${id}...`;
            const r = await fetch(`/api/sources/${id}/refresh`, { method: 'POST' });
            const data = await r.json();
            msgEl.textContent = data.ok
              ? `数据源 #${id} 已刷新：${data.network_status}`
              : `数据源 #${id} 刷新失败：${data.error || data.network_status || '未知错误'}`;
            await loadSources();
          });
        });
      }

      async function loadSources() {
        const days = Number(daysEl.value || 7);
        const r = await fetch(`/api/sources?days=${days}`);
        state.sources = await r.json();
        renderTable();
      }

      async function addSource(e) {
        e.preventDefault();
        const feed_url = document.getElementById('feedUrl').value.trim();
        const title = document.getElementById('title').value.trim();
        const site_url = document.getElementById('siteUrl').value.trim();
        if (!feed_url) return;
        msgEl.textContent = '添加中...';
        const r = await fetch('/api/sources', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ feed_url, title, site_url, probe: true })
        });
        const data = await r.json();
        if (data.ok) {
          msgEl.textContent = data.probe_error ? `已添加，探测失败：${data.probe_error}` : '添加成功';
          e.target.reset();
          await loadSources();
        } else {
          msgEl.textContent = data.error || '添加失败';
        }
      }

      async function prefillLocalGist() {
        try {
          msgEl.textContent = '正在预填本地 Gist 数据...';
          const r = await fetch('/api/sources/prefill-local-gist', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: 'data/gist_sources_weekly.json' })
          });
          const data = await r.json();
          if (data.ok) {
            msgEl.textContent = `预填完成，共导入 ${data.imported} 条`;
          } else {
            msgEl.textContent = `预填失败：${data.error || '未知错误'}`;
          }
        } catch (e) {
          msgEl.textContent = `预填异常：${String(e)}`;
        } finally {
          await loadSources();
        }
      }

      async function importOnlineGist() {
        msgEl.textContent = '正在从在线 Gist 导入...';
        const r = await fetch('/api/sources/import-gist', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ probe: false })
        });
        const data = await r.json();
        if (data.ok) {
          msgEl.textContent = `在线导入完成，共导入 ${data.imported} 条`;
          await loadSources();
        } else {
          msgEl.textContent = `在线导入失败：${data.error || '未知错误'}`;
        }
      }

      document.getElementById('addForm').addEventListener('submit', addSource);
      daysEl.addEventListener('change', loadSources);
      document.getElementById('prefillBtn').addEventListener('click', prefillLocalGist);
      document.getElementById('importGistBtn').addEventListener('click', importOnlineGist);

      loadSources().then(prefillLocalGist);
    </script>
  </body>
</html>
